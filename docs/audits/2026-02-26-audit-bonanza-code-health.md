# Audit: code_health — bonanza-api

> **Date:** 2026-02-26
> **Target:** bonanza-api (multi-module Go API, hexagonal architecture, ~17k functions)
> **Category:** code_health
> **Reported Score:** 91/100
> **Estimated Accurate Score:** 78-82/100
> **Auditors:** 4 parallel agents (false positives, false negatives, thresholds/math, issue quality)

---

## 1. Summary

Openkraft scored bonanza-api's code_health at 91/100 with 456 issues. Audit reveals **53% of issues are false positives** from generated code, test files, and the Reconstruct DDD pattern. The score is **inflated by 10-13 points** due to denominator dilution from test/generated functions. Additionally, the `SubMetric` field is never populated on issues (a bug that breaks skip filtering), and the zero-function edge case incorrectly scores 0/20 instead of full credit.

## 2. Target Project Profile

| Metric | Value |
|--------|-------|
| Language | Go 1.24 |
| Architecture | Hexagonal, per-feature layout |
| Files analyzed | 1,481 |
| Functions analyzed | 16,987 |
| Test ratio | 0.67 (594 test files / 887 source files) |
| Modules | 27 |
| Generated code | 87 sqlc files in `internal/database/sqlc/` |

## 3. Bugs Found

| # | Type | Severity | Description | File:Line |
|---|------|----------|-------------|-----------|
| 1 | Bug | **P0** | `SubMetric` field never set on code_health issues — breaks `skip.sub_metrics` config filtering | `scoring/code_health.go:202-250` |
| 2 | Bug | **P0** | Zero functions → 0/20 on 4 sub-metrics instead of full credit or N/A | `scoring/code_health.go` (all `score*` funcs) |
| 3 | Bug | **P1** | `int()` truncation instead of `math.Round()` creates asymmetric cliff at every 5% boundary | `scoring/code_health.go` (all `score*` funcs) |

## 4. False Positives

Issues reported that should NOT have been reported.

| Category | Count | % of 456 | Root Cause |
|----------|-------|----------|------------|
| Generated code (sqlc) | ~45 | 10% | No `// Code generated` detection; sqlc files penalized for file_size and function_size |
| Test files (`_test.go`) | ~184 | 40% | Tests scored identically to production code; table-driven tests are idiomatically long |
| Reconstruct pattern | ~74 | 16% | DDD reconstruction functions with many params are a deliberate architectural choice |
| **Total false positives** | **~243** | **53%** | |

### Examples

**Generated code:**
- `internal/database/sqlc/models.go` — 2,699 lines, flagged for file_size. File starts with `// Code generated by sqlc. DO NOT EDIT.`
- `internal/database/sqlc/customers.sql.go` — 2,558 lines, same issue. Not human-authored.

**Test code:**
- `sales/adapters/http/sales_requests_test.go` → `TestCreateSaleRequest_Validation` (186 lines) — table-driven validation test with struct literals. Idiomatic Go.
- `routes/adapters/http/routes_handler_test.go` — 1,851 lines total. HTTP handler test file with many small test functions. Normal for handler testing.
- `customers/domain/customer_test.go` → `TestNewCustomer` (154 lines) — constructor test with many fields. Expected for a 69-field entity.

**Reconstruct pattern:**
- `ReconstructCustomer` (69 params) — maps 69 DB columns to unexported struct fields. The alternative is exported fields (breaks encapsulation) or reflection (worse). This is the correct DDD pattern in Go.
- `ReconstructCredit` (50 params), `ReconstructCreditPlan` (35 params) — same pattern across all domain entities.

## 5. False Negatives

Real problems the scorer MISSED.

| Missing Metric | Impact | Example in bonanza-api |
|----------------|--------|------------------------|
| God structs (>15 fields) | High | `Customer` struct with 69 fields, `Credit` with 51 fields |
| Ignored errors (`_ =`) | High | 362 instances of `_ =` error suppression across production code |
| Cyclomatic complexity | Medium | Handlers with 10+ sequential if/else blocks (nesting=1 but complexity=11) |
| Function coupling | Medium | `SalesService` (975 lines) imports from multiple domains |
| Magic numbers | Low | `3600`, `1024`, `4096` hardcoded throughout |

## 6. Threshold Analysis

Openkraft defaults are 15-40% stricter than Go ecosystem linter defaults.

| Metric | openkraft | golangci-lint / revive | Verdict |
|--------|-----------|----------------------|---------|
| MaxFunctionLines | 50 | 60 (funlen) | Slightly strict |
| MaxFileLines | 300 | ~500-800 (informal) | **Very strict** |
| MaxNestingDepth | 3 | 5 (nestif) | **Very strict** |
| MaxParameters | 4 | 5 (revive/argument-limit) | Slightly strict |
| MaxConditionalOps | 2 | No direct equivalent | **Very strict** |

This is acceptable IF documented as "AI-readiness thresholds" (stricter because AI agents need simpler code). Currently not documented.

## 7. Scoring Math

### Formula

Each sub-metric uses: `score = int(ratio * points)` where `ratio = earned / total` and `points = 20`.

Three-tier credit per function:

| Tier | Credit | function_size example |
|------|--------|----------------------|
| Full | 1.0 | <= 50 lines |
| Partial | 0.5 | 51-100 lines |
| Zero | 0.0 | > 100 lines |

### Dilution problem

With 16,987 functions in the denominator, extreme outliers are invisible:
- `ReconstructCustomer` (69 params) contributes the same 0.0 penalty as a function with 7 params
- Thousands of small test/generated functions earning 1.0 dilute the ratio to ~98%+

### Two-threshold confusion

Scoring uses one threshold (e.g., 50 lines), issues use a higher threshold (e.g., 100 lines). Functions at 51-100 lines lose score points but generate NO diagnostic output. The detail string says "max 50 lines" but issues say ">100" — two different numbers with no explanation.

### Small sample size problem

| Functions | 1 partial violation | Score loss |
|-----------|-------------------|------------|
| 100 | ratio = 99.5% | 1 point |
| 5 | ratio = 90% | 2 points |
| 1 | ratio = 50% | **10 points** |

## 8. Issue Quality

### All 456 issues are "warning" severity

A function with 69 parameters has the same severity as a file with 501 lines. No prioritization.

**Recommended tiering:**
- `ratio >= 3x threshold` → error (e.g., 69 params when limit is 7)
- `ratio >= 1.5x` → warning
- else → info

### Messages not actionable

Current: `"function ReconstructCustomer has 69 parameters (≥7)"`
Missing: what to do about it, which sub-metric it belongs to, what the project p90 is.

### No grouping

74 Reconstruct issues are the same pattern repeated. Should be 1 summary issue.

### Missing fields

- `SubMetric`: exists in struct, never populated → breaks skip filtering
- `Pattern`: exists in struct, never populated → could enable grouping

## 9. Recommendations

### P0 — Bugs

1. **Set `SubMetric` on all code_health issues** — without this, `skip.sub_metrics` config is silently broken for code_health.
   - File: `internal/domain/scoring/code_health.go`, function `collectCodeHealthIssues`
   - Fix: add `SubMetric: "function_size"` (etc.) to each issue append

2. **Zero functions → full credit** — a file with no functions has no violations.
   - File: `internal/domain/scoring/code_health.go`, all `score*` functions
   - Fix: when `total == 0`, return `sm.Score = sm.Points`

3. **Use `math.Round()` instead of `int()`** for score calculation.
   - File: `internal/domain/scoring/code_health.go`
   - Fix: `sm.Score = int(math.Round(ratio * float64(sm.Points)))`

### P1 — Scoring Accuracy

4. **Detect and exclude generated code** — files starting with `// Code generated` should be skipped from code_health scoring.
   - Option A: `AnalyzedFile.IsGenerated` flag set by parser when it encounters the comment
   - Option B: skip files in `database/sqlc/`, `*_gen.go`, etc. via pattern matching

5. **Relaxed thresholds for test files** — either exclude `_test.go` from code_health (precedent: discoverability, predictability, context_quality already do this) or double the thresholds for test code.

6. **Severity tiering** — replace hardcoded `SeverityWarning` with ratio-based severity:
   ```
   ratio := actual / threshold
   >= 3.0 → error | >= 1.5 → warning | else → info
   ```

7. **Exempt Reconstruct pattern** — functions matching `Reconstruct*` should use a higher parameter limit (e.g., 100) or be excluded from parameter_count.

### P2 — Issue Quality / UX

8. **Populate `SubMetric` and `Pattern` fields** — enables filtering, grouping, and skip config.

9. **Group repeated patterns** — 74 Reconstruct issues → 1 summary issue with top offenders listed.

10. **Add actionable suggestions** — based on violation type:
    - parameter_count >= 10: "consider using an options struct"
    - function_size > 200: "consider splitting into smaller functions"
    - file_size for `_test.go`: "consider splitting into multiple test files"

11. **Add top-N summary** — `top_issues` field with the 10 most severe issues sorted by excess over threshold.

12. **Clarify two-threshold system** — detail string should show: "95% within 50 lines (partial credit up to 100 lines)" instead of just "max 50 lines".

## 10. Fix Plan Reference

Implementation plan: `docs/plans/2026-02-26-fix-code-health-accuracy.md`
